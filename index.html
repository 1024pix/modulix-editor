<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Modulix Editor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"
      integrity="sha512-q3eWabyZPc1XTCmF+8/LuE1ozpg5xxn7iO89yfSOd5/oKvyqLngoNGsx8jq92Y8eXJ/IRxQbEC+FGSYxtk2oiw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jodit@4.2.27/es2015/jodit.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h1>Modulix Editor</h1>

    <main class="modulix-editor">

      <div>


        <div class="mb-2">
          <a class="btn btn-outline-info" href="https://app.pix.fr/modules/preview" target="_blank">
            <span class="fa fa-eye"></span>
            Prévisualiser
          </a>
          <button class="btn btn-outline-danger" id="reset-button">
            <span class="fa fa-trash"></span>
            Réinitialiser
          </button>
        </div>
        <h2>Contenu</h2>
        <div id="editor_holder"></div>
      </div>

      <div class="modulix-editor__render">
        <h2>JSON à copier/coller</h2>

        <textarea
          id="json_output"
          class="modulix-editor-render__input"
        ></textarea>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jodit@4.2.27/es2018/jodit.fat.min.js"></script>
    <script type="module">
      import { schema } from './modulix.json-schema.js';
      import LocalBackup from './LocalBackup.js';

      const element = document.getElementById('editor_holder');
      const jsonOutput = document.getElementById('json_output');

      Jodit.defaultOptions.toolbarAdaptive = false;
      Jodit.defaultOptions.buttons =
        'paragraph,|,bold,italic,strikethrough,link,eraser,|,ul,ol,|,hr,|,source';
      Jodit.defaultOptions.controls.paragraph.list = {
        p: 'Paragraph',
        h3: 'Heading 3',
        h4: 'Heading 4',
        blockquote: 'Quote',
        code: 'Source code',
      };
      Jodit.defaultOptions.controls.ul.list = null;
      Jodit.defaultOptions.controls.ol.list = null;

      schema.format = 'categories';
      schema.properties.transitionTexts.items.properties.grainId.format = '';

      const editor = new JSONEditor(element, {
        schema,
        theme: 'bootstrap5',
        iconlib: 'fontawesome5',
        no_additional_properties: true,
        disable_edit_json: true,
        disable_properties: true,
        disable_array_reorder: true,
        form_name_root: 'Module',
      });

      const resetButton = document.querySelector('#reset-button');
      resetButton.addEventListener('click', () => {
        if (window.confirm('Voulez-vous vraiment réinitialiser le module ? Toutes les modifications seront perdues.')) {
          editor.setValue({})
        }
      });

      editor.on('change', () => {
        if (JSON.stringify(editor.getValue(), null, 2) !== jsonOutput.value) {
          jsonOutput.value = JSON.stringify(editor.getValue(), null, 2);
        }

        displayJsonOutputError();
        LocalBackup.save(editor.getValue());
      });

      jsonOutput.addEventListener('focusout', () => {
        try {
          const value = JSON.parse(jsonOutput.value);
          editor.setValue(value);
        } catch (error) {
          console.error(error);
        }

        displayJsonOutputError();
      });

      function displayJsonOutputError() {
        try {
          JSON.parse(jsonOutput.value);
          jsonOutput.classList.remove(
            'modulix-editor-render__input--has-error'
          );
        } catch {
          jsonOutput.classList.add('modulix-editor-render__input--has-error');
        }
      }

      editor.on('ready', () => {
         const schema = LocalBackup.load();
         editor.setValue(schema);
      });
    </script>
  </body>
</html>
